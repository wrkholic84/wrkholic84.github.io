---
title: "[K8S] ArgoCD"
# author: wrkholic84
date: 2024-01-30 00:06:00 +0900
categories: [Development, Kubernetes]
tags: [kubernetes, security]
math: true
mermaid: true
# image:
#   path: /commons/devices-mockup.png
#   width: 800
#   height: 500
#   alt: Responsive rendering of Chirpy theme on multiple devices.
---
## ArgoCD
Kubernetes 모의해킹 자료 정리하다가 알게된 ArgoCD.

DevOps 환경에서 반드시 사용될 것으로 생각되어 사용해보기로 함. 너무 편해보여서 나도 써야겠음.

## 설치
### 1.1. ArgoCD 설치 (Master)

```bash
ubuntu@master:~$ kubectl create namespace argocd
ubuntu@master:~$ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```

### 1.2. ArgoCD CLI 설치 (Master)
```bash
ubuntu@master:~$ curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
ubuntu@master:~$ sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
ubuntu@master:~$ rm ./argocd-linux-amd64
```

### 1.3. 초기 비밀번호 확인  
이후에 관리자가 비밀번호를 변경하더라도 이 값은 바뀌지 않음.
```bash
ubuntu@master:~$ kubectl get secret -n argocd argocd-initial-admin-secret -o jsonpath={.data.password} | base64 -d
# <Password 표시됨>
```

### 1.4. 접속 테스트

브라우저로 접속 후 위에서 확인한 비밀번호로 로그인.
```bash
ubuntu@master:~$ kubectl port-forward --address=0.0.0.0 svc/argocd-server -n argocd 8080:443
```
아래와 같은 화면을 확인할 수 있음
![00](/assets/images/posts/20240130ArgoCD/00.png)

## Ingress 설정
이거때문에 너무 고생을 했다.

EKS를 사용하지 않고, EC2에 직접 Kubernetes를 설치하였기 때문에,
Route53(domain.com) > ALB > Ingress > Argo Service 로 라우팅을 잡을 것이다.

### 2.1. AWS - 대상그룹 생성
기본구성
- 인스턴스
- 대상그룹이름
  - ARGOCD-TASK
- 프로토콜 : 포트
  - HTTPS : 30851
```bash
ubuntu@master:~$ kubectl get svc -n ingress-nginx
NAME                                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx-controller             NodePort    10.105.213.161   <none>        80:31983/TCP,443:30851/TCP   6h23m
ingress-nginx-controller-admission   ClusterIP   10.99.246.21     <none>        443/TCP                      6h23m
```
- 상태 검사 프로토콜
  - HTTPS , /healthz
- 사용 가능한 인스턴스
  - worker node 선택

### 2.2. AWS - ALB 생성
- 이름
  - ARGOCD-ALB

- 네트워크 매핑
  - ap-northeast-2a (Public AZ 선택)
  - ap-northeast-2c (Public AZ 선택)

- 보안그룹
  - 적절히 생성 (나중에 상세히 설정)

- 리스너 및 라우팅 
  - HTTPS:443 / ARGOCD-TASK

- 보안 리스너 설정
  - 인증서 설정

### 3.1. ArgoCD 서비스 확인  
argocd-server 서비스를 외부 인터넷에서 접속할 수 있도록 할 예정
```bash
ubuntu@master:~$ kubectl get svc -n argocd
NAME                                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
argocd-applicationset-controller          ClusterIP   10.99.168.87     <none>        7000/TCP,8080/TCP            23h
argocd-dex-server                         ClusterIP   10.103.239.103   <none>        5556/TCP,5557/TCP,5558/TCP   23h
argocd-metrics                            ClusterIP   10.108.60.54     <none>        8082/TCP                     23h
argocd-notifications-controller-metrics   ClusterIP   10.102.164.141   <none>        9001/TCP                     23h
argocd-redis                              ClusterIP   10.97.50.179     <none>        6379/TCP                     23h
argocd-repo-server                        ClusterIP   10.110.146.193   <none>        8081/TCP,8084/TCP            23h
argocd-server                             ClusterIP   10.110.181.12    <none>        80/TCP,443/TCP               23h
argocd-server-metrics                     ClusterIP   10.106.46.163    <none>        8083/TCP                     23h
```

### 3.2. Ingress 작성 및 적용
여러 annotations를 조합하여 설정해보았는데, [공식문서](https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#kubernetesingress-nginx)에서 가이드 하는대로 하는게 제일 좋더라..

리다이렉트 문제로 좀 고생을 했는데, 바로 이어서 설명.
```bash
ubuntu@master:~$ cat ./argocd-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: argocd-server-ingress
  namespace: argocd
  annotations:
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
spec:
  ingressClassName: nginx
  rules:
  - host: argocd.domain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: argocd-server
            port:
              name: https
```

그리고 반영.
```bash
ubuntu@master:~$ kubectl apply -f ./argocd-ingress.yaml
ingress.networking.k8s.io/argocd-server-ingress created
ubuntu@master:~$ kubectl get ingress -n argocd
NAME                    CLASS   HOSTS               ADDRESS         PORTS   AGE
argocd-server-ingress   nginx   argocd.hack8s.com   172.31.82.157   80      5h15m
```

이대로 argocd-server-ingress를 타고 잘 들어오면 너무 좋았겠지만, https 리다이렉트가 기본 설정이라는 이유로, 계속 리다이렉트가 발생하는 현상이 나타났다. 
```bash
ubuntu@master:~$ curl -k -L https://argocd.domain.com
curl: (47) Maximum (50) redirects followed
```

노력끝에, 해결방법을 찾았고, 다음과 같이 ArgoCD의 configmap 설정을 변경하면 리다이렉트가 발생하지 않았음.  
HTTP로 요청이 들어와도, HTTPS로 리다이렉트 하지 않는 설정. 의아한건, ssl-passthrough로 HTTPS로 들어오고 있다는 생각..
뭐가 맞는진 잘 모르겠음.
```bash
ubuntu@master:~$ kubectl edit configmap argocd-cmd-params-cm -n argocd
apiVersion: v1
data:                       # 추가
  server.insecure: "true"   # 추가
kind: ConfigMap
ubuntu@master:~$ kubectl rollout restart deploy argocd-server -n argocd  # ArgoCD 서버 재시작
ubuntu@master:~$ curl -k -L https://argocd.domain.com/healthz
ok
```

## ArgoCD 테스트
### 4.1. 로그인
```bash
ubuntu@master:~$ export ARGOCD_SERVER=argocd.domain.com 
ubuntu@master:~$ argocd version --grpc-web
argocd: v2.8.9+3ef5ba7
  BuildDate: 2024-01-19T18:33:48Z
  GitCommit: 3ef5ba76a95d71de88bfa9b6e887c86025a88fdd
  GitTreeState: clean
  GoVersion: go1.20.12
  Compiler: gc
  Platform: linux/amd64
argocd-server: v2.9.3+6eba5be
  BuildDate: 2023-12-01T23:05:50Z
  GitCommit: 6eba5be864b7e031871ed7698f5233336dfe75c7
  GitTreeState: clean
  GoVersion: go1.21.3
  Compiler: gc
  Platform: linux/amd64
  Kustomize Version: v5.2.1 2023-10-19T20:13:51Z
  Helm Version: v3.13.2+g2a2fb3b
  Kubectl Version: v0.24.2
  Jsonnet Version: v0.20.0
ubuntu@master:~$ argocd login argocd.domain.com --grpc-web
Username: admin
Password:
'admin:login' logged in successfully
Context 'argocd.domain.com' updated     # 앞서 로그인 한 적 있음.
```

## Trouble Shooting
### 5.1. ArgoCD 통신 문제
모두 설치하고, ArgoCD에 Repo 및 Application 생성을 시도했는데, 자꾸 DNS 쿼리에 실패하는 듯한 에러가 발생
```bash
ubuntu@master:~$ argocd repo add https://github.com/abc/abc.git
FATA[0020] rpc error: code = Unavailable desc = connection error: desc = "transport: Error while dialing: dial tcp: lookup argocd-repo-server: i/o timeout"
```
문제는 CoreDNS가 고장나 있었다. CordDNS를 재시작하는 것으로 해결
```bash
ubuntu@master:~$ kubectl -n kube-system rollout restart deployment coredns
deployment.apps/coredns restarted
```